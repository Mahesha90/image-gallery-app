<!DOCTYPE html>
<html>
<head>
  <title>Gallery</title>
  <link rel="stylesheet" href="/css/style.css">
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
</head>
<body>
  <h1> Image Gallery</h1>

  <!-- Welcome + auth links -->
  <p>
    Welcome, <%= user ? user.username : "Guest" %>!
    <% if (user) { %>
      <a href="/logout">Logout</a>
    <% } else { %>
      <a href="/login">Login</a>
    <% } %>
  </p>

  <!-- Navigation when logged in -->
  <% if (user) { %>
    <a href="/profile">Go to Profile Page</a>
    <a href="/upload">Upload New Image</a>
  <% } %>

  <div class="gallery">
    <% if (images && images.length > 0) { %>
      <% images.forEach(image => { %>
        <div class="gallery-row">
          <!-- Image -->
          <div class="gallery-image">
            <img src="/uploads/<%= image.filename %>" alt="Image">
          </div>



          <!-- Visibility Info + Button -->
          <div class="gallery-actions delete">
  <% if (user && user.id === image.user_id) { %>
    <form method="POST" action="/delete-image" style="margin-bottom: 8px;">
      <input type="hidden" name="filename" value="<%= image.filename %>">
      <button type="submit" onclick="return confirm('Are you sure you want to delete this image?');">
        Delete
      </button>
    </form>

    <form method="POST" action="/toggle-visibility">
      <input type="hidden" name="filename" value="<%= image.filename %>">
      <button type="submit">
        Make <%= image.visibility === 'public' ? 'Private' : 'Public' %>
      </button>
    </form>
  <% } else { %>
    <!-- empty div to keep grid alignment -->
  <% } %>
</div>


          <!-- Rating Form -->
          <div class="gallery-actions star-rating">
            <% if (user) { %>
              <form method="POST" action="/rate" style="display:inline;">
                <input type="hidden" name="image_id" value="<%= image.id %>">
                <% let userRating = image.user_rating || 0; %>
                <% for (let i = 1; i <= 5; i++) { %>
                  <button
                    type="submit"
                    name="rating"
                    value="<%= i %>"
                    class="star-button <%= i <= userRating ? 'star-filled' : 'star-empty' %>"
                    aria-label="Rate <%= i %> star<%= i > 1 ? 's' : '' %>"
                    title="Rate <%= i %> star<%= i > 1 ? 's' : '' %>"
                  >
                    <i class="fa-solid fa-star"></i>
                  </button>
                <% } %>
              </form>
            <% } else { %>
              <!-- empty div to keep grid alignment -->
            <% } %>
          </div>

          <!-- Average rating below stars, visually aligned -->
          <% if (image.avg_rating !== undefined && image.avg_rating !== null) { %>
            <div style="grid-column: 4; text-align: left; font-size: 0.9em; margin-top: 5px; color: #333;">
              Average rating: <strong><%= Number(image.avg_rating).toFixed(1) %> / 5</strong>
            </div>
          <% } %>
        </div>
      <% }) %>
    <% } else { %>
      <p>No images found.</p>
    <% } %>
  </div>

</body>
</html>
